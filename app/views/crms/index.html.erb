  <p id="notice"><%= notice %></p>

  <div class="container">
    <div class="row">
      <h1>Estudiantes</h1>
    </div>
  </div>
  <br><br>
  <div class="container">
      <%= form_tag crms_path, :method => 'get' do %>
      <%= hidden_field_tag :direction, params[:direction] %>
      <%= hidden_field_tag :sort, params[:sort] %>
    <div class="row">
        <div class="col-4">
          <%= link_to 'Agregar estudiante', new_crm_path, class: " btn btn-success" %>
        </div>
        <div class="form_group col-4">
           <%= text_field_tag :search, params[:search], class: "form-control", placeholder: "Filtra" %>
        </div>
        <div class="form_group col-1">
            <%= submit_tag "Search", :name => nil , class: "btn btn-primary" %>
        </div>
        <br>
      <% end %>
    </div>
  </div>
  <br><br><br>
  <div class="container">
    <div class="row">
      <div class="col-sm">
        <p>Total de estudiantes activos: <strong><%= Crm.where(public_status: "Activo").count %></strong>
      </div>
      <br><br>
      <div class="col-sm">
        <p>Total de estudiantes cancelados: <strong><%= Crm.where(public_status: "Cancelado").count %></strong></p>
      </div>
    </div>
  </div>

<div class="container">
  <table class="table">
    <thead>
      <tr class="text-center">
        <th><%= sortable "user_id", "Nombre" %></th>
        <th>Teléfono</th>
        <th><%= sortable "language_id", "Idioma" %></th>
        <th>Membresía</th>
        <th>País</th>
        <th>Horario</th>
        <th><%= sortable "user_id", "Profesor" %></th>
        <th><%= sortable "buy_credits", "Créditos comprados" %></th>
        <th><%= sortable "free_credits", "Créditos regalados" %></th>
        <th>Horas completadas</th>
        <th>Horas ganadas</th>
        <th>Horas perdidas</th>
        <th>Clases próximas</th>
        <th>Balance de créditos</th>
        <th><%= sortable "subscription_renewal", "# de veces de renovación" %></th>
        <th><%= sortable "private_status", "Estatus privado" %></th>
        <th><%= sortable "public_status", "Estatus público" %></th>
        <th>Comentarios</th>
        <th colspan="3"></th>
      </tr>
    </thead>

    <tbody>
      <% @crms.each do |student| %>
        <tr class="text-center">
          <td><%= link_to student.user.name.titleize, student.user %></td>
          <td><%= student.user.phone_number %></td>
          <td><%= Language.find_by(id: student.user.language_id).name %></td>
          <td><%= Plan.find_by(id: student.user.plan_id).name.titleize %></td>
          <td><%= student.user.country_name %></td>
          <td><%= student.user.schedule %></td>
          <td><% if student.user.inverse_students.first == nil %> 

              <% else %>
                <%= student.user.inverse_students.first.name.titleize %>
              <% end %>                  
          </td>
          <td><%= student.buy_credits %></td>
          <td><%= student.free_credits %></td>
          <td><%= student.user.inverse_lessons.where( status_id: "Completada").sum(:time_duration_id)/60 %></td>
          <td><%= student.user.inverse_lessons.where( status_id: "Perdida por el profesor").sum(:time_duration_id)/60 %></td>
          <td><%= student.user.inverse_lessons.where( status_id: "Perdida por el estudiante").sum(:time_duration_id)/60 %></td>
          <td><%= student.user.inverse_lessons.where( status_id: "Próxima").count(:time_duration_id) %></td>
          <!-- Model for calculating credits balance = Hours bought + hours won by policy + hours given away by us - completed hours - hours lost by policy -->
          <td><%= student.buy_credits.to_f + student.user.inverse_lessons.where( status_id: "Perdida por el profesor").sum(:time_duration_id)/60 + student.free_credits.to_f - student.user.inverse_lessons.where( status_id: "Completada").sum(:time_duration_id)/60 - student.user.inverse_lessons.where( status_id: "Perdida por el estudiante").sum(:time_duration_id)/60  %></td>
          <td><%= student.subscription_renewal %></td>
          <td><%= student.private_status %></td>
          <td><%= student.public_status %></td>
          <td><%= student.comment %></td>
          <td><%= link_to '', edit_crm_path(student), class:"fa fa-edit fa-x" %></td>
          <td><%= link_to '', student, method: :delete, data: { confirm: 'Are you sure?' }, class:"fa fa-close fa-x", style:"color:#DC3C45" %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>


    <div class="container">
      <div class="pagination">
        <%= will_paginate @crms, renderer: @renderer %>
      </div>
    </div>


